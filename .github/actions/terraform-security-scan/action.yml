name: "Terraform Security Scan (All)"
description: "Trivy static + plan scan with SARIF, artifacts & alerts"

inputs:
  tfvars-file:
    required: true
  environment:
    required: true
  backend-file-path:
    required: true
    default: 'backend.hcl'

runs:
  using: "composite"
  steps:
    - name: Get Terraform Version
      uses: ./.github/actions/terraform/version

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ steps.tf-version.outputs.version }}

    - name: Terraform Init
      shell: bash
      run: |
        set -euo pipefail
        ls -la
        echo "Initializing Terraform with backend: ${{ inputs.backend-file-path }}"
        terraform init -upgrade -backend-config="${{ inputs.backend-file-path }}"
        terraform providers

    # ========================
    # Static Trivy Scan
    # ========================
    - name: Trivy Static Scan - Pretty
      id: static
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        format: table
        skip-dirs: .terraform,bootstrap
        severity: CRITICAL,HIGH,MEDIUM,LOW
        exit-code: '1'

    - name: Trivy Static Scan - SARIF
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        format: sarif
        skip-dirs: .terraform,bootstrap
        output: trivy-static.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW

    # ========================
    # Terraform Plan â†’ JSON
    # ========================
    - name: Terraform Plan (JSON)
      shell: bash
      run: |
        terraform plan -var-file="${{ inputs.tfvars-file }}" -out=tfplan
        terraform show -json tfplan > tfplan.json

    # ==========================
    # Plan Trivy Scan (Dynamic)
    # ==========================
    - name: Trivy Plan Scan - Pretty
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        input: tfplan.json
        format: table
        skip-dirs: .terraform,bootstrap
        severity: CRITICAL,HIGH,MEDIUM,LOW
        exit-code: '1'

    - name: Trivy Plan Scan - SARIF
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        input: tfplan.json
        format: sarif
        skip-dirs: .terraform,bootstrap
        output: trivy-plan.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW

    # # Upload SARIF to GitHub Security tab 'sji can I? think this is paid
    # - name: Upload SARIF
    #   if: always()
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: |
    #       trivy-static.sarif
    #       trivy-plan.sarif

    # # ========================
    # # Artifact Upload
    # # ========================
    # - name: Upload Scan Artifacts
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: terraform-security-scan-${{ github.run_number }}-${{ inputs.environment }}
    #     path: |
    #       trivy-static.sarif
    #       trivy-plan.sarif
    #       tfplan.json
    #       backend.hcl
    #     retention-days: 90
    #     if-no-files-found: warn