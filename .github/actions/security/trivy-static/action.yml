# .github/actions/security/terraform-security-scan/action.yml
# ... (same inputs as before)

runs:
  using: "composite"
  steps:
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init -backend-config="${{ inputs.backend-file-path }}"

    # ── Static Scan (replaces tfsec) ──────────────────────────────────
    - name: Trivy Static Scan → Table (pretty log)
      id: static-table
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        format: table
        severity: CRITICAL,HIGH,MEDIUM,LOW
        exit-code: '1'

    - name: Trivy Static Scan → SARIF
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        format: sarif
        output: trivy-static.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW

    # ── Plan + Dynamic Scan ───────────────────────────────────────────
    - name: Terraform Plan (JSON)
      run: terraform plan -var-file="${{ inputs.tfvars-file }}" -json > tfplan.json

    - name: Trivy Plan Scan → Table (pretty log)
      id: plan-table
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: terraformplan
        scan-ref: tfplan.json
        format: table
        severity: CRITICAL,HIGH,MEDIUM,LOW
        exit-code: '1'

    - name: Trivy Plan Scan → SARIF
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: terraformplan
        scan-ref: tfplan.json
        format: sarif
        output: trivy-plan.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW

    # ── Upload SARIF to GitHub Security Tab ───────────────────────────
    - name: Upload Static SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-static.sarif

    - name: Upload Plan SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-plan.sarif

    # ── Upload Human-Readable Artifacts (optional but nice) ───────────
    - name: Upload Trivy Logs as Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-scan-results-${{ github.run_number }}
        path: |
          trivy-static.sarif
          trivy-plan.sarif
          tfplan.json
        retention-days: 30