# name: Terraform Deploy

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:
#   terraform:
#     runs-on: ubuntu-latest
#     permissions:
#       id-token: write
#       contents: read

#     steps:
#       # Checkout the repository
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # Configure AWS credentials (using OIDC if possible)
#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: arn:aws:iam::<your_aws_account_id>:role/<github-actions-role> # Replace with your role ARN
#           aws-region: eu-north-1

#       # Install Terraform
#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3
#         with:
#           terraform_version: 1.9.7

#       # Get AWS Account ID
#       - name: Get AWS Account ID
#         id: account_id
#         run: |
#           ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
#           echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

#       # Apply bootstrap.tf to create S3 bucket and DynamoDB table
#       - name: Terraform Init (Bootstrap)
#         working-directory: bootstrap
#         run: terraform init

#       - name: Terraform Apply (Bootstrap)
#         working-directory: bootstrap
#         run: terraform apply -auto-approve

#       # Get the S3 bucket name from bootstrap output
#       - name: Get S3 Bucket Name
#         id: bucket_name
#         working-directory: bootstrap
#         run: |
#           BUCKET_NAME=$(terraform output -raw state_bucket_name)
#           echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV

#       # Initialize main.tf with dynamic bucket name
#       - name: Terraform Init (Main)
#         working-directory: main
#         run: |
#           terraform init \
#             -backend-config="bucket=${{ env.BUCKET_NAME }}" \
#             -backend-config="key=arches-k8s/terraform.tfstate" \
#             -backend-config="region=eu-north-1" \
#             -backend-config="dynamodb_table=terraform-locks"

#       # Terraform Plan
#       - name: Terraform Plan
#         working-directory: main
#         run: terraform plan -out=tfplan

#       # Terraform Apply
#       - name: Terraform Apply
#         if: github.event_name == 'push'
#         working-directory: main
#         run: terraform apply -auto-approve tfplan