#unfinished - we need to add proper change control around this for uat and prod deployments
#sji todo
name: Terraform CD

on:
  push:
    branches: [ main ]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.backend.tfvars'
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, stage, uat, prod]
        required: true

permissions:
  contents: read
  security-events: write
  deployments: write

jobs:
  # ── Non-Prod: Auto ──
  non-prod:
    if: github.event_name == 'push' || github.event.inputs.environment != 'prod'
    strategy:
      matrix:
        environment: [dev, stage, uat]
    environment: ${{ matrix.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Security Scan
        uses: ./.github/actions/security-scan

      - name: Terraform Plan & Apply
        uses: ./.github/actions/terraform-cd
        with:
          environment: ${{ matrix.environment }}
          tfvars-file: ${{ matrix.environment }}.tfvars
          backend-file: ${{ matrix.environment }}.backend.tfvars
          auto-apply: "true"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ── Prod: Manual Gate ── sji todo
  prod:
    if: github.event.inputs.environment == 'prod'
    environment:
      name: prod
      url: https://console.aws.amazon.com
    needs: non-prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Security Scan
        uses: ./.github/actions/security-scan

      - name: Terraform Plan
        uses: ./.github/actions/terraform-cd
        with:
          environment: prod
          tfvars-file: prod.tfvars
          backend-file: prod.backend.tfvars
          auto-apply: "false"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: "admin-team"
          minimum-approvals: 1

      - name: Terraform Apply
        if: steps.manual-approval.outputs.approved == 'true'
        run: |
          terraform init -backend-config=prod.backend.tfvars
          terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}